#!/usr/bin/env bash

# backup timetstamped database
# $bin/backup_db technical_diary_production

set -e #Exit immediately if a command exits with a non-zero status.

# First argument = database name (required)
DB_NAME=$1
# So if the argument is omitted, exit with message:
# Usage: ./backup_db <database_name>

if [ -z "$DB_NAME" ]; then
  echo "Usage: $0 <database_name>"
  exit 1
fi

# Define backup directory
BACKUP_DIR="db/backups"

# Ensure the backup directory exists
mkdir -p "$BACKUP_DIR"

# Get current timestamp
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# Priority: argument > RAILS_ENV > development
# RAILS_ENV=${1:-${RAILS_ENV:-development}}
# Extract database name for the chosen environment
# DB_NAME=$(grep "database:" config/database.yml | grep "$RAILS_ENV" | awk '{print $2}')

# Set backup file name
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_backup_$TIMESTAMP.sql.gz"

# Dump database and compress
echo "Backing up database '$DB_NAME' to '$BACKUP_FILE'..."
pg_dump "$DB_NAME" | gzip > "$BACKUP_FILE"

echo "âœ… Backup completed successfully."
